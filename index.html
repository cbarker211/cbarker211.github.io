<!doctype html>
<html lang="en">
<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Rocket Launch Emissions</title>

<link rel="icon" type="image/x-icon" href="assets/images/favicon_rocket.ico">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<link rel="stylesheet" href="style.css" type="text/css" media="screen" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter+Tight:ital,wght@0,281;1,281&family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

<script src="https://cdn.plot.ly/plotly-3.2.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/globe.gl"></script>
<script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

<!-- TODO: Set up Google Analytics -->

</head>

<body>

	<style>

		/* ✨ 3D Moving Starfield Background */
		#starfield {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			z-index: -1; /* sits behind your content */
			background: radial-gradient(circle at 50% 50%, #0a0f24, #05070f 80%);
		}

		*, ::after, ::before {
			box-sizing: content-box !important;
		}

		#slider, #slider * {
			box-sizing: border-box !important;
		}

		p {
			margin-top: 0.85em;
			margin-bottom: 0.85em;
		}

		.filter-container {
			display: flex; 
			flex-direction: column; 
		}

		.filter {
			position: relative;
			background: #143d59;
			color: whitesmoke;
			padding: 0.3em;
			height: auto;
			cursor: pointer; /* show pointer on hover */
			text-align: left;
			margin-top: 0.5em;
		}

		.filter label {
			font-size: 1.125em;
			user-select: none;
			display: inline-flex;
			align-items: center;
			gap: 0.375rem;
		}

		.filter label::after {
			content: '';
			display: inline-block;
			width: 0; 
			height: 0; 
			border-left: 0.4em solid transparent;
			border-right: 0.4em solid transparent;
			border-top: 0.4em solid whitesmoke;
			vertical-align: middle;
			transition: transform 0.3s ease;
			margin-left: 0.5em;
		}

		/* Arrow down (open) */
		.filter.open label::after {
			transform: rotate(180deg);
		}

		/* Remove any arrows from dropdown labels */
		.dropdown label::after {
			display: none !important;
			content: none !important;
		}
		
		/* Hide dropdown initially */
		.dropdown ul {
			display: none;
			position: absolute;
			list-style-type: none;
			background-color: #8dc4ee;
			max-height: 30vh;
			overflow-y: auto;
			width: 100%;
			min-width: unset; /* Ensure a minimum width */
			white-space: normal;
			border-radius: 0.3rem;
			z-index: 100;
			top: calc(100% + 0.3rem);
			left: calc(0% - 0.3rem);
		}

		.dropdown label {
			font-size: 1.2em;
			display: flex;
			align-items: center;
			text-align: left;
			padding: 0;
		}

		.filter.open .dropdown ul {
			display: block;
			padding: 0.4em;
		}

		.wrap-text {
			white-space: normal;
			word-wrap: break-word;
			max-width: 25vh; /* Adjust the width as needed */
		}

		.tab-pane {
			height: 100%;
			display: flex; /* Ensure children align properly */
    		flex-direction: column; /* Align children vertically */
			background: rgba(255, 255, 255, 0.08);        /* semi-transparent glass */
			backdrop-filter: blur(0.85em) brightness(1.05); /* blur background */
			-webkit-backdrop-filter: blur(0.85em) brightness(1.05); /* Safari */
			border-radius: 1em;                           /* rounded corners */
			border: 0.1em solid rgba(255, 255, 255, 0.2);   /* subtle border */
			box-shadow: 0 0.5em 2em rgba(0, 0, 0, 0.2);    /* optional shadow */
			box-sizing: border-box;
			padding: 1em;
			overflow: hidden;
		}

		.tab-pane .row {
			flex-grow: 1;
			height: 100%;
		}

		.row {
			margin: 0;
			padding: 0;
			height: 100%;
		}

		.col-8, .col-4 {
			height: 100%;
			padding: 0;
		}

		.globe-tabpane, .chart-tabpane {
			height: 100%;
			width: 100%;
		}

		.apply-filters {
			padding: 0.4em;
			background-color: #143d59;
			border: 0.1em solid #ccc;
			border-radius: 0.5em;
			color: whitesmoke;
			margin: 0;
		}

		#myTab {
			padding-left: 0;
		}

		#myTabContent {
			margin: 1em 0 1em 0;
			height: 52vh;
			display: flex; /* Optional: Ensures children align properly */
			flex-direction: column; /* Optional: Aligns children vertically */
		}

		.nav-tabs{
			border: 0;
			font-size: 1.6em;
		}

		.nav-tabs .nav-item {
			padding-right: 1em;
			margin: 0;
		}

		.nav-tabs .nav-link {
			background-color: #143d59;
			color: whitesmoke;
			margin-bottom: 0;
			border: 0.1em solid transparent;
			border-bottom-left-radius: 0;
			padding: 0.2em;
		}

		.nav-tabs .nav-link:hover {
			background-color: #246a99;
			border-color: transparent;
		}

		.nav-tabs .nav-link.active {
			background-color: #588db1;
			font-weight: bold;
			color: whitesmoke;
			border-color: #588db1;
			box-shadow: inset 0 0 0 0 transparent, 0 0 0 0 transparent, inset 0 0 0 0 transparent, 0 0.3rem 0 0 #143d59;
		}

		.nav-tabs-container {
			border-bottom: 0.3rem solid #e9e9e9; /* or your desired color */
		}

		/* Container to align the tables side by side */
		.table-container {
			position: relative;
		}

		/* Table styling */
		table, .site-table {
			width: 100%;
			border-collapse: collapse;
			white-space: nowrap;
			color: black;
		}

		th, td, tr {
			padding: 0.3em;
			text-align: left;
			border: 0.1em solid #ddd;
			white-space: nowrap;
		}

		#site-table th, 
		#site-table td {
			word-wrap: break-word;
		}

		#site-table th:first-child,
		#site-table td:first-child {
			width: 150px; /* adjust as needed */
		}

		th {
			background-color: #dddddd;
		}

		tbody, tr {
			background-color: #ffffff;
		}

		tfoot {
			font-weight: bold;
			background-color: #ffffff;
		}

		.faq-item {
			display: block;
			margin-top: 0.5rem;
		}

		.item-question {
			background: #143d59;
			color: whitesmoke;
			font-size: 1.125em;
			padding: 0.5rem;
			display: flex;
			justify-content: space-between;
			align-items: center;
			text-align: left;
		}
		.question-text {
			display: inline-block;
		}
		.arrows-container {
			margin: 0.4rem;
		}
		.item-answer {
			display: none;
			color: rgb(0, 0, 0);
			padding: 0.7em;
		}
		.close {
			display: none;
		}

		.show-answer .item-answer {
			display: block;
			background: #8dc4ee;
		}
		.show-answer .close {
			display: inline;
		}
		.show-answer .expand {
			display: none;
		}

		/* Style for the arrow button on the table*/
		.arrow-button {
			padding: 0.2em;
			background: #143d59;
			border: none;
			margin: none;
			color: whitesmoke;			
			font-size: 1em; /* Increase size for better visibility */
			position: absolute; /* Position relative to the table container */
			left: -1.4em; /* Place the button outside the table on the right */
			width: 1em;
			height: calc(0.3em *2 + 0.1em *2 + 1em - 0.2em*2);
			z-index: 10; /* Ensure the button is above other elements */
		}

		.arrow-button:focus {
			outline: none;
		}

		/* Styling for the date range slider */

		.noUi-horizontal {
			height: 0.35em;
		}

		.noUi-target {
			border: none;
			background: #e9e9e9;
		}

		.noUi-value {
			margin-top: 0.5em;
		}

		.noUi-tooltip {
			padding: 0;
			border: 0;
			color: #ffffff;
			background-color: transparent;
		}

		.noUi-connect {
			background: #588db1;;
		}

		.noUi-handle {
			background: #143d59;
			box-shadow: none;
			border: 0;
			border-radius: 50%; 
		}

		.noUi-handle:before, .noUi-handle:after {
			display: none;
		}

		.noUi-pips-horizontal {
			padding: 0.7em;
			height: 0.7em;
			color: #ffffff;
		}

		.noUi-marker, .noUi-marker-large {
			background:  #ffffff;
		}

		.noUi-horizontal .noUi-handle{
			width: 1.4em;
			height: 1.4em;
			color: #000000;
			right: -0.7em;
			top: -0.7em;
		}

	</style>

	<canvas id="starfield"></canvas>

	<div class="main-row">

		<div class="left-column">

			<h1 style="text-align: center; padding-top:0.2em;">Rocket Launch Emissions</h1>
			<p style="text-align: left;">Welcome to our tracker of pollutant and greenhouse gas emissions from rocket launches! Select a time window of interest to visualise pollution on interactive plots or a 3D globe. For more information, see the FAQs at the bottom of this section. </p>	
	
			<h2>Filters</h2>

			<button class="apply-filters" type="submit" id="applyFilters">Apply Filters</button>
				
			<div class="filter-container">

				<div class="filter">
					<label>Launch Site</label>
					<div class="dropdown" id="locationFilter">
						<ul></ul>
					</div>
				</div>
			
				<div class="filter">
					<label>Launch Vehicle</label>
					<div class="dropdown" id="rocketFilter">
						<ul></ul>
					</div>
				</div>
			
				<div class="filter">
					<label>Megaconstellation</label>
					<div class="dropdown" id="smcFilter">
						<ul></ul>
					</div>
				</div>
					
			</div>
			<h2>Frequently Asked Questions</h2>
			<div id="faqs-container"></div>

			<script>
				const faqData = [ 
					{ question: "What are these chemicals?",
						answer: "NO<sub>x</sub> is nitrogen oxides, H<sub>2</sub>O is water vapour, CO<sub>2</sub> is carbon dioxide, BC is black carbon or soot, Al<sub>2</sub>O<sub>3</sub> is aluminium oxide or alumina, and Cl<sub>y</sub> is a family of chlorine compounds. NO<sub>x</sub>, H<sub>2</sub>O, CO<sub>2</sub>, and Cl<sub>y</sub> are released as gases, BC and Al<sub>2</sub>O<sub>3</sub> as particles."
					},
					{ question: "How do these chemicals affect the atmosphere?",
						answer: "Unlike man-made emissions from the surface of the Earth, rocket launches release air pollutant and CO<sub>2</sub> emissions throughout the atmosphere, where they can have an outsized impact on our atmosphere and climate. NO<sub>x</sub> and Cl<sub>y</sub> are the largest contributors to destruction of the ozone layer from rocket emissions, with smaller destruction occuring from emissions of BC and Al<sub>2</sub>O<sub>3</sub> particles. The largest climate impacts come from BC emissions, which warm the upper layers of the atmosphere while cooling the lower layers."
					},
					{ question: "What does each filter represent?",
						answer: "Launch site refers to the location of the rocket launch. Launch vehicle refers to the type of rocket used for the launch. Megaconstellation refers to whether the launch contains megaconstellation payloads."
					},
					{ question: "How is this data calculated?",
						answer: "Our calculations are based on the current best scientific knowledge available for emissions from rocket launches. We include the effects of a changing chemical environment with altitude in our launch emissions, and calculate emissions globally up to a maximum altitude of 80 km. Paths shown in the Globe view are fixed at the launch site and do not represent real rocket trajectories."
					},
					{ question: "Where can I find the original methodology and data?",
					answer: "You can find further details in our study published in Nature Scientific Data: Global 3D rocket launch and re-entry air pollutant and carbon dioxide emissions for 2020-2022</strong>. C. R. Barker, E. A. Marais (2024). doi:10.5522/04/26325382. [<a href='https://doi.org/10.5522/04/26325382' target='_blank' rel='noopener noreferrer'>Data</a>]. [<a href='https://www.nature.com/articles/s41597-024-03910-z' target='_blank' rel='noopener noreferrer'>Publication</a>]."
					}
				];

				const faqsContainer = document.getElementById('faqs-container');

				faqData.map(function(item) {

					let article = document.createElement('article');
					article.classList.add('faq-item');

					const markup = `
							<div class="filter">
								<label>${item.question}</label>
							</div>
							<div class="item-answer">
								<span>${item.answer}</span>
							</div>
					`;
					
					article.innerHTML = markup;
					faqsContainer.append(article);
				});

				const faqQuestions = document.querySelectorAll('.filter');
					
				faqQuestions.forEach(question => {
					question.addEventListener('click', function(e) {
						const faqItem = question.parentElement;
						faqItem.classList.toggle("show-answer");
					});
				});

			</script>
		</div>
		
		<div class="center-column">
			<!-- Tabs for charts and globe -->
			<div class="nav-tabs-container d-flex justify-content-between align-items-center">
				<ul class="nav nav-tabs" id="myTab" role="tablist">
					<li class="nav-item" role="presentation">
					<button class="nav-link active" id="chart-tab" data-bs-toggle="tab" data-bs-target="#chart-tabpane" type="button" role="tab" aria-controls="chart" aria-selected="true">Emissions Data</button>
					</li>
					<li class="nav-item" role="presentation">
					<button class="nav-link"        id="globe-tab" data-bs-toggle="tab" data-bs-target="#globe-tabpane" type="button" role="tab" aria-controls="globe" aria-selected="false">Launch Sites</button>
					</li>
				</ul>
			</div>

			<div class="filter-container">
				<div id="slider" style="margin:3em;"></div>
			</div>

			<div style="display:flex; justify-content:space-between; align-items:center; margin-top:1em;">
				<div>
				  <select id="month-select1"></select>
				  <select id="year-select1"></select>
				</div>
				<div>
				  <select id="month-select2"></select>
				  <select id="year-select2"></select>
				</div>
			</div>

			<div class="tab-content" id="myTabContent">
				<div class="tab-pane fade show active" id="chart-tabpane"   role="tabpanel" aria-labelledby="chart-tab">
					<div class="row">
						<div class="col-8" style="padding:0;"> <!-- 75% -->
							<div id="stack" class="chart"></div>
						</div>
						<div class="col-4" style="padding:0;"> <!-- 25% -->
							<div id="bar" class="chart"></div>
						</div>
					</div>
				</div>
				<div class="tab-pane fade" id="globe-tabpane" role="tabpanel" aria-labelledby="globe-tab">
					<div style="display: flex;">
						<div id="globe" class="globe" style="width: 50vw;"></div>
						<div id="site-details" style="width: 50vw; padding: 0 1em 1em 1em;">
							<h3 style="padding-top:0; margin: 0;">Launch Site Details</h3>
							<p style="text-align: left;">[click on site path for more information]</p>
							<table id="site-table" border="1">
								<tr>
									<th>Property</th>
									<th>Value</th>
								</tr>
							</table>
						</div>
					</div>
					
				</div>
			</div>

			<!-- Table for Launch Locations -->
			<div class="table-container">
				<div>
					<h3 style="margin: 0;">Launch Details (Click arrow to expand)</h3>
					<p style="text-align: left;">[Emissions in tonnes, time in UTC. SMC=Satellite Megaconstellation]</p>
					<table id="launchTable">
						<thead>
							<tr>
								<th>Date</th>
								<th>ID</th>
								<th>Time</th>
								<th>Launch Site</th>
								<th>Rocket</th>
								<th>SMC</th>
								<th>BC</th>
								<th>CO</th>
								<th>CO<sub>2</sub></th>
								<th>H<sub>2</sub>O</th>
								<th>Al<sub>2</sub>O<sub>3</sub></th>
								<th>Cl<sub>y</sub></th>
								<th>NO<sub>x</sub></th>
							</tr>
						</thead>
						<tbody id="launchTableBody" style="display: none;">
							<!-- Dynamic rows for launch locations will be inserted here -->
						</tbody>
						<tfoot id="launchTableFoot">
							<!-- Totals for launches -->
						</tfoot>
						<button id="toggleTableButton" class="arrow-button">&#9650;</button>
					</table>
				</div>
			</div>
		</div>
	</div>

	<script>

		const startYear = 1955;
		const endYear = 2024;
		const totalMonths = (endYear - startYear + 1) * 12 - 1;
		let globe;
		var slider = document.getElementById('slider');

		function indexToDate(index) {
			const year = startYear + Math.floor(index / 12);
			const monthIndex = Math.floor(Number(index)) % 12; // 0–11
			const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
								"Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
			return `${monthNames[monthIndex]} ${year}`;
		}

		function updateSiteTable(site) {
			const table = document.getElementById('site-table');
			table.innerHTML = `<tr><th>Property</th><th>Value</th></tr>`;

			const cleanedLaunches = site.labels.map(label => label.replace(/^Launch\s+/, ''));

			const launchesHTML = `
				<div style="
					max-height: 150px; 
					overflow-y: auto; 
					padding: 4px; 
					border: 1px solid rgba(255, 255, 255, 0.2);
					border-radius: 4px;
					background: rgba(255, 255, 255, 0.05);
				">
					${cleanedLaunches.join('<br>')}
				</div>
			`;

			const rows = [
				['Name', site.name],
				['Latitude', site.lat + 1],
				['Longitude', site.lng],
				['Number of Launches', site.labels.length],
				['Launches', launchesHTML],
			];

			rows.forEach(([prop, val]) => {
				const tr = document.createElement('tr');
				tr.innerHTML = `<td class="wrap-text">${prop}</td><td class="wrap-text">${val}</td>`;
				table.appendChild(tr);
			});
		}

		function intToDateString(monthIndex, isEnd = false) {
			const year = startYear + Math.floor(monthIndex / 12);
			const month = monthIndex % 12;

			if (isEnd) {
				// Create a date for the *last day* of the month
				const lastDay = new Date(year, month + 1, 0); // day 0 of next month = last day of current
				return lastDay.toISOString().split('T')[0];
			} else {
				// First day of the month
				const firstDay = new Date(year, month, 1);
				return firstDay.toISOString().split('T')[0];
			}
			}

		noUiSlider.create(slider, {
			start: [780, 839],
			connect: true,
			step: 1,
			range: {
				min: 0,
				max: totalMonths,
			},
			tooltips: [        
				{
					to: value => indexToDate(value),
					from: () => 0
				},
				{
					to: value => indexToDate(value),
					from: () => 0
				}
			],
			format: {
				to: value => Math.round(value),
				from: value => Number(value)
			},
			pips: {
				mode: 'steps',
				density: 100,
				filter: function(value) {
					// Show label only every 30 months (5 years)
					if (value % 60 === 0) return 1;  // every 5 years → major tick + label
					if (value % 12 === 0) return 2;  // every 1 year → minor tick
					return 0;   
				},
				format: {
					to: function(value) {
						// label only for year start (Jan)
						return value % 60 === 0 ? (startYear + value / 12) : '';
					}
				}
			}
		});	

		var yearSelect1 = document.getElementById('year-select1');
		var yearSelect2 = document.getElementById('year-select2');

		// Append the option elements
		for (var i = 1957; i <= 2024; i++) {

			var option1 = document.createElement("option");
			option1.text = i;
			option1.value = i;

			var option2 = document.createElement("option");
			option2.text = i;
			option2.value = i;

			yearSelect1.appendChild(option1);
			yearSelect2.appendChild(option2);
		}

		var monthSelect1 = document.getElementById('month-select1');
		var monthSelect2 = document.getElementById('month-select2');

		var months = [
		"Jan", "Feb", "Mar", "Apr", "May", "Jun",
		"Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
		];

		months.forEach((month, index) => {
		var option1 = document.createElement("option");
		option1.text = month;
		option1.value = index + 1; // 1 = Jan, 12 = Dec

		var option2 = document.createElement("option");
		option2.text = month;
		option2.value = index + 1;

		monthSelect1.appendChild(option1);
		monthSelect2.appendChild(option2);
		});

		slider.noUiSlider.on('update', (values, handle) => {
			const startIndex = Math.round(values[0]);
			const endIndex = Math.round(values[1]);

			// Update the selects to match the slider
			const start = fromMonthIndex(startIndex);
			const end = fromMonthIndex(endIndex);

			monthSelect1.value = start.month;
			yearSelect1.value = start.year;
			monthSelect2.value = end.month;
			yearSelect2.value = end.year;
		});

		slider.noUiSlider.on('end', (values) => {
			const startIndex = Math.round(values[0]);
			const endIndex = Math.round(values[1]);

			startDate = intToDateString(startIndex);
			endDate = intToDateString(endIndex, true);
			fetchEventsData();
		});

		function fromMonthIndex(index) {
			const year = startYear + Math.floor(index / 12);
			const month = (index % 12) + 1; // 1–12
			return { year, month };
		}

		function toMonthIndex(year, month) {
			return (year - startYear) * 12 + (month - 1);
		}

		function updateSliderFromSelects() {
			console.log(yearSelect1.value,yearSelect2.value,monthSelect1.value,monthSelect2.value)
			// Convert month/year to an index (months since startYear)
			let startMonthIndex =
				(yearSelect1.value - startYear) * 12 + (monthSelect1.value - 1);
			let endMonthIndex =
				(yearSelect2.value - startYear) * 12 + (monthSelect2.value - 1);

			if (endMonthIndex <= startMonthIndex) {
				endMonthIndex = startMonthIndex + 1;

				// Update the selects so UI reflects the change
				let newEndYear = startYear + Math.floor(endMonthIndex / 12);
				let newEndMonth = (endMonthIndex % 12) + 1;

				yearSelect2.value = newEndYear;
				monthSelect2.value = newEndMonth;
			}

			slider.noUiSlider.set([startMonthIndex, endMonthIndex]);

			startDate = intToDateString(startMonthIndex);
			endDate = intToDateString(endMonthIndex, true);
			console.log(startDate, endDate);
			fetchEventsData();
		}

		yearSelect1.addEventListener('change', updateSliderFromSelects);
		monthSelect1.addEventListener('change', updateSliderFromSelects);
		yearSelect2.addEventListener('change', updateSliderFromSelects);
		monthSelect2.addEventListener('change', updateSliderFromSelects);

		function populateFilters(launches) {
			// Get unique values from filtered_launches for each filter
			const locations = [...new Set(launches.text)];
			const rockets = [...new Set(launches.rocket)];
			const smcValues = [...new Set(launches.smc)];

			// Function to populate checkboxes inside a given filter dropdown
			function populateCheckboxes(filterId, values) {
				const dropdown = document.getElementById(filterId);
				const ul = dropdown.querySelector('ul');
				ul.innerHTML = ''; // Clear any previous entries

				values.forEach(value => {
					const li = document.createElement('li');
					li.innerHTML = `<label><input type="checkbox" value="${value}" /> ${value}</label>`;
					ul.appendChild(li);
				});
			}

			// Populate each filter
			populateCheckboxes('locationFilter', locations.sort());
			populateCheckboxes('rocketFilter', rockets.sort());
			populateCheckboxes('smcFilter', smcValues);
		}

		function filterlaunches(all_launches) {

			function getSelectedfilters(filter) {
				const var_filter = document.getElementById(filter);
				const checkboxes = var_filter.querySelectorAll('input[type="checkbox"]:checked');
				return Array.from(checkboxes).map(checkbox => checkbox.value);
			}

			// Get selected values from each filter
			const selectedLocations = getSelectedfilters('locationFilter');
			const selectedRockets   = getSelectedfilters('rocketFilter');
			const selectedSmc       = getSelectedfilters('smcFilter');

			// Find indices to keep based on selected filters
			let indicesToKeep = [...Array(all_launches.date.length).keys()];  // All indices initially

			// Filter based on location
			if (selectedLocations.length > 0) {
				indicesToKeep = indicesToKeep.filter(i => selectedLocations.includes(all_launches.text[i]));
			}

			// Filter based on rocket
			if (selectedRockets.length > 0) {
				indicesToKeep = indicesToKeep.filter(i => selectedRockets.includes(all_launches.rocket[i]));
			}

			// Filter based on smc
			if (selectedSmc.length > 0) {
				indicesToKeep = indicesToKeep.filter(i => selectedSmc.includes(all_launches.smc[i]));	
			}

			// Filter the column arrays using the indicesToKeep
			const filteredData = {
				date: indicesToKeep.map(i => all_launches.date[i]),
				time: indicesToKeep.map(i => all_launches.time[i]),
				lat: indicesToKeep.map(i => all_launches.lat[i]),
				lon: indicesToKeep.map(i => all_launches.lon[i]),
				text: indicesToKeep.map(i => all_launches.text[i]),
				id: indicesToKeep.map(i => all_launches.id[i]),
				rocket: indicesToKeep.map(i => all_launches.rocket[i]),
				smc: indicesToKeep.map(i => all_launches.smc[i] ? "Yes" : "No"),
				BC: indicesToKeep.map(i => all_launches.BC[i]),
				CO: indicesToKeep.map(i => all_launches.CO[i]),
				CO2: indicesToKeep.map(i => all_launches.CO2[i]),
				H2O: indicesToKeep.map(i => all_launches.H2O[i]),
				Al2O3: indicesToKeep.map(i => all_launches.Al2O3[i]),
				Cly: indicesToKeep.map(i => all_launches.Cly[i]),
				NOx: indicesToKeep.map(i => all_launches.NOx[i]),
			};

			// Update the visualizations with the filtered data
			updateVisualizations(filteredData);
		}
		
		async function fetchEventsData() {
			try {
				// Fetch the data from the API (replace with your actual API URL)
				// Data is in tonnes in json files.
				const response1 = await fetch(`https://cbarker.pythonanywhere.com/api/launches?start_date=${startDate}&end_date=${endDate}`); // Replace with your actual API URL
				const launchData = await response1.json();
				
				all_launches = {
					date: [],
					time: [],
					lat: [],
					lon: [],
					text: [],
					id: [],
					rocket: [],
					smc: [],
					BC: [],
					CO: [],
					CO2: [],
					H2O: [],
					Al2O3: [],
					Cly: [],
					NOx: []
				};

				Object.keys(launchData).forEach(date => {
					launchData[date].launches.forEach(launch => {
						all_launches.date.push(launch.date);
						all_launches.time.push(launch.time)
						all_launches.lat.push(parseFloat(launch.lat));
						all_launches.lon.push(parseFloat(launch.lon));
						all_launches.text.push(launch.location);
						all_launches.id.push(launch.id);
						all_launches.rocket.push(launch.rocket);
						all_launches.smc.push(launch.smc.toString());
						all_launches.BC.push(launch.emissions.BC);
						all_launches.CO.push(launch.emissions.CO);
						all_launches.CO2.push(launch.emissions.CO2);
						all_launches.H2O.push(launch.emissions.H2O);
						all_launches.Al2O3.push(launch.emissions.Al2O3);
						all_launches.Cly.push(launch.emissions.Cly);
						all_launches.NOx.push(launch.emissions.NOx);
					});
				});
				
				populateFilters(all_launches);
				updateVisualizations(all_launches);

			} catch (error) {
				console.error('Error fetching or processing the events data:', error);
			}
		}

		function updateVisualizations(filtered_launches) {
			updateTables(filtered_launches);
			updateGraph(filtered_launches);
			updateGlobe(filtered_launches);
			updateStack(filtered_launches);
		}

		const prettyNames = {
			BC: 'BC',
			CO: 'CO',
			CO2: 'CO<sub>2</sub>',
			H2O: 'H<sub>2</sub>O',
			Al2O3: 'Al<sub>2</sub>O<sub>3</sub>',
			Cly: 'Cl<sub>y</sub>',
			NOx: 'NO<sub>x</sub>'
		};

		const strongColors = {
			BC: 'rgba(0,0,0,1)',
			CO: '#A820A8',
			CO2: '#969696',
			H2O: '#2c20c9',
			Al2O3: '#c40000',
			Cly: '#1cba26',
			NOx: '#c99b24'
		};

		function updateGlobe(filtered_launches) {

			// Step 1: Group launches by site (lat/lng + site name as key)
			const siteMap = {};
			filtered_launches.lat.forEach((lat, i) => {
				const lng = filtered_launches.lon[i];
				const site = filtered_launches.text[i];  // launch site name
				const id = filtered_launches.id[i];
				const vehicle = filtered_launches.rocket[i];
				const key = `${site}}`;

				if (!siteMap[key]) {
					siteMap[key] = {
					lat: lat - 1,
					lng,
					name: site,
					labels: []
					};
				}

				siteMap[key].labels.push(`Launch ${id} - ${vehicle}`);
			});

			const gData = filtered_launches.lat.map((latitude, index) => {
				const longitude = filtered_launches.lon[index];
				const site = filtered_launches.text[index];
				const key = `${site}}`;
				const siteInfo = siteMap[key];

				return {
					lat: latitude,
					lon: longitude,
					siteObj: siteInfo   
					//name: `Launch ID ${filtered_launches.id[index]}`,
				};
			});

			// Step 2: Convert to array
			const labelSites = Object.values(siteMap).sort((a, b) => a.lat - b.lat);
			const OPACITYPATH  = 0.3;

			if (!globe) {
				globe = new Globe(document.getElementById('globe'))
					.globeImageUrl('https://cdn.jsdelivr.net/npm/three-globe/example/img/earth-blue-marble.jpg')
					.showGraticules(true)
					.pointLat(d => d.lat)
					.pointLng(d => d.lon)
					.pointColor(() => `rgba(0, 255, 0, ${OPACITYPATH})`)
					.pointRadius(0.4)
					.pointAltitude(d => 0.05 + 0.0005 * d.siteObj.labels.length)
					.labelLat(d => d.lat)
					.labelLng(d => d.lng)
					.labelText(d => d.name)
					//.labelLabel(d => d.labels.join('<br>'))  // Hover over label gives launch IDs.
					.labelResolution(2)
					.labelsTransitionDuration(0)
					.labelSize(1)
					.labelDotRadius(0)
					.onPointClick(d => {
						updateSiteTable(d.siteObj);
						globe.labelsData([d.siteObj]);
					})
				
				globe.labelsData([]);
				globe.pointsData(gData);

				setTimeout(() => {
				globe
					.pointOfView({ lat: 35, lng: -95, altitude: 1.5 }, 1000);
				}, 0);
		
			} else {
				globe.pointsData(gData);
				globe.labelsData(labelSites);
			}
		}

		function updateTables(filtered_launches) {
			
			const table1Body = document.getElementById('launchTableBody');
			const table1Foot = document.getElementById('launchTableFoot');
			table1Body.innerHTML = '';
			table1Foot.innerHTML = '';
			let totalBC = 0, totalCO = 0, totalCO2 = 0, totalH2O = 0;
			let totalAl2O3 = 0, totalCly = 0, totalNOx = 0;
			filtered_launches.id.forEach((location, index) => {
				const row = document.createElement('tr');
				const BC = filtered_launches.BC[index];
				const CO = filtered_launches.CO[index];
				const CO2 = filtered_launches.CO2[index];
				const H2O = filtered_launches.H2O[index];
				const Al2O3 = filtered_launches.Al2O3[index];
				const Cly = filtered_launches.Cly[index];
				const NOx = filtered_launches.NOx[index];
				totalBC    += BC;
				totalCO    += CO;
				totalCO2   += CO2;
				totalH2O   += H2O;
				totalAl2O3 += Al2O3;
				totalCly   += Cly;
				totalNOx   += NOx;
				row.innerHTML = `
					<td>${filtered_launches.date[index]}</td> 
					<td>${location}</td>  
					<td>${filtered_launches.time[index].toFixed(2)}</td> 
					<td class="wrap-text">${filtered_launches.text[index]}</td> 
					<td class="wrap-text">${filtered_launches.rocket[index]}</td> 
					<td>${filtered_launches.smc[index]}</td> 
					<td>${filtered_launches.BC[index].toFixed(1)}</td> 
					<td>${filtered_launches.CO[index].toFixed(1)}</td> 
					<td>${filtered_launches.CO2[index].toFixed(1)}</td> 
					<td>${filtered_launches.H2O[index].toFixed(1)}</td> 
					<td>${filtered_launches.Al2O3[index].toFixed(1)}</td> 
					<td>${filtered_launches.Cly[index].toFixed(1)}</td> 
					<td>${filtered_launches.NOx[index].toFixed(1)}</td> 
				`;
				table1Body.appendChild(row);
			});
			// Add Totals to Launch Table
			const totalRow1 = document.createElement('tr');
			totalRow1.innerHTML = `
				<td>Total</td>
				<td>-</td>
				<td>-</td>
				<td>-</td>
				<td>-</td>
				<td>-</td>
				<td>${totalBC.toFixed(1)}</td>
				<td>${totalCO.toFixed(1)}</td>
				<td>${totalCO2.toFixed(1)}</td>
				<td>${totalH2O.toFixed(1)}</td>
				<td>${totalAl2O3.toFixed(1)}</td>
				<td>${totalCly.toFixed(1)}</td>
				<td>${totalNOx.toFixed(1)}</td>
			`;
			table1Foot.appendChild(totalRow1);
		}
		
		function updateGraph(filtered_launches) {

			const totals = {
				BC: 0,
				CO: 0,
				CO2: 0,
				H2O: 0,
				Al2O3: 0,
				Cly: 0,
				NOx: 0
			};
			filtered_launches.id.forEach((location, index) => {
				totals.BC    += filtered_launches.BC[index];
				totals.CO    += filtered_launches.CO[index];
				totals.CO2   += filtered_launches.CO2[index];
				totals.H2O   += filtered_launches.H2O[index];
				totals.Al2O3 += filtered_launches.Al2O3[index];
				totals.Cly   += filtered_launches.Cly[index];
				totals.NOx   += filtered_launches.NOx[index];
			});
			
			// Prepare the data for Plotly
			const maxYValue = Object.values(totals).reduce((sum, val) => sum + val, 0);
			
			const trace = Object.keys(totals).map(key => ({
				x: ['Total'],
				y: [totals[key] / 1000]  ,
				name: prettyNames[key],
				type: 'bar',
				marker: {color: strongColors[key]}
			}));
			
			const layout = {
				paper_bgcolor: 'rgba(0,0,0,0)',
				plot_bgcolor: 'rgba(0,0,0,0)',
				autosize: true,
				font: { color: 'white', family: 'Space Grotesk, sans-serif', size: 14}, // general font
				legend: { 
					orientation: 'v',
					x: 1.05, 
					y: 1, 
					itemwidth: 3, 
					font: { 
					color: 'white', 
					size: 13, 
					family: 'Space Grotesk, sans-serif'
					}
				},
				title: {
					text: 'Total Emissions [kt]',
				    xref: 'paper',
					xanchor: 'center',
					yref:'paper',
					y: 1,
					pad: { t: -30 }},
				barmode: 'stack',
				yaxis: {
					range: [0,maxYValue / 1000]
				},
				margin: { t: 70, r: 40, b: 20, l: 40 } 
			};

			// Plot the chart inside the 'emissionsChart' div
			Plotly.newPlot('bar', trace, layout, {responsive: true, displayModeBar: true });

		}

		function updateStack(filtered_launches) {

			const species = ['BC', 'CO', 'CO2', 'H2O', 'Al2O3', 'Cly', 'NOx'];
			const monthlySums = {};

			// Step 1: Loop through each launch (index)
			for (let i = 0; i < filtered_launches.date.length; i++) {
				const month = filtered_launches.date[i].slice(0, 7);  // 'YYYY-MM'
				if (!monthlySums[month]) {
					monthlySums[month] = {};
					species.forEach(sp => monthlySums[month][sp] = 0);
				}
				species.forEach(sp => {
					monthlySums[month][sp] += Number(filtered_launches[sp][i]) || 0; // Ensure numeric
				});
				}

			const months = Object.keys(monthlySums).sort();
			const maxYValue = Math.max(...months);

			const traces = species.map(sp => ({
				x: months,
				y: months.map(m => monthlySums[m][sp] / 1000),
				stackgroup: 'one',
				name: prettyNames[sp],
				type: 'scatter',
				mode: 'none',
				fillcolor: strongColors[sp]
			}));

			const layout = {
				paper_bgcolor: 'rgba(0,0,0,0)',
				plot_bgcolor: 'rgba(0,0,0,0)',
				autosize: true,
				font: { color: 'white', family: 'Space Grotesk, sans-serif', size: 14}, // general font
				legend: { 
					orientation: 'v',
					x: 1.05, 
					y: 1, 
					itemwidth: 3, 
					font: { 
					color: 'white', 
					size: 13, 
					family: 'Space Grotesk, sans-serif'
					}
				},
				title: {
					text: 'Monthly Emissions (click legend to show/hide species)',
				    xref: 'paper',
					xanchor: 'center',
					yref:'paper',
					y: 1,
					pad: { t: -30 }},
				yaxis: {
					title: {
						text: 'Mass [kilotonnes]',
					},
					range: [0,maxYValue / 1000]
				},

				margin: { t: 70, r: 40, b: 20, l: 40 } 
			};
			Plotly.newPlot('stack', traces , layout, {responsive: true, displayModeBar: true });

		}

		// Plot a default date when the page opens, then update when the date changes.
		document.addEventListener('DOMContentLoaded', () => {

			const daterange = slider.noUiSlider.get();
			startDate = intToDateString(Number(daterange[0]));
			endDate = intToDateString(Number(daterange[1]));
			fetchEventsData(); // Fetch data for the default date

			document.getElementById('applyFilters').addEventListener('click', () => {
				filterlaunches(all_launches);
			});

			const tabEls = document.querySelectorAll('button[data-bs-toggle="tab"]');
			tabEls.forEach(function (tab) {
				tab.addEventListener('shown.bs.tab', function (event) {
					const activatedTabId = event.target.id;
					if (activatedTabId === 'chart-tab') {
						// Resize your Plotly charts
						Plotly.Plots.resize(document.getElementById('stack'));
						Plotly.Plots.resize(document.getElementById('bar'));
					}
					if (activatedTabId === 'globe-tab') {
						// Resize your Globe.gl renderer (assuming you have one)
						if (window.globe) {
							resizeGlobe();
						}
					}
				});
			});
		});

		// JavaScript to toggle the table visibility and update the arrow
		const toggleButton = document.getElementById('toggleTableButton');
		const tableBody = document.getElementById('launchTableBody');

		toggleButton.addEventListener('click', () => {
			const isHidden = tableBody.style.display === 'none';
			tableBody.style.display = isHidden ? 'table-row-group' : 'none';
			toggleButton.innerHTML = isHidden ? '&#9660;' : '&#9650;'; // Down arrow when shown, up arrow when hidden
		});

		document.querySelectorAll('.filter').forEach(filter => {
			filter.addEventListener('click', e => {
				// Prevent toggling when clicking inside dropdown list itself
				if (e.target.closest('.dropdown ul')) return;

				// Close other open dropdowns first (optional)
				document.querySelectorAll('.filter.open').forEach(openFilter => {
				if (openFilter !== filter) openFilter.classList.remove('open');
				});

				// Toggle current filter open class
				filter.classList.toggle('open');
			});
		});

		// Optional: Close dropdowns if clicked outside
		document.addEventListener('click', e => {
			if (!e.target.closest('.filter')) {
				document.querySelectorAll('.filter.open').forEach(openFilter => {
				openFilter.classList.remove('open');
				});
			}
		});

		// Function to resize the globe based on its container size
		const resizeGlobe = () => {
			const container = document.getElementById('globe');
			const screenHeight = window.innerHeight;
			const globeHeight = screenHeight * 0.52 - 30;
			const globeWidth = container.offsetWidth - 30;
			globe.width(globeWidth).height(globeHeight);
			
			// Manually reset the canvas element size to match the container size
			const canvas = document.querySelector('#globe canvas');
			if (canvas) {
				canvas.style.width = `${globeWidth}px`;
				canvas.style.height = `${globeHeight}px`;
				canvas.style.transform = 'none';
			}	
		};

		const canvas = document.getElementById("starfield");
		const ctx = canvas.getContext("2d");

		let stars = [];
		const numStars = 50;

		function resize() {
			canvas.width = window.innerWidth;
			canvas.height = window.innerHeight;
			stars = Array.from({ length: numStars }, () => ({
				x: (Math.random() - 0.5) * canvas.width * 5,
				y: (Math.random() - 0.5) * canvas.height* 5,
				z: Math.random() * canvas.width
			}));
		}

		resize();
		let resizeTimeout;

		window.addEventListener("resize", () => {
			clearTimeout(resizeTimeout);
			resizeTimeout = setTimeout(resize, 300);
		});

		let last = 0;
		const targetFPS = 30;
		function animate(timestamp) {
			const timeSinceLastFrame = timestamp - last;
			if (timeSinceLastFrame < 1000 / targetFPS) {
				requestAnimationFrame(animate);
				return;
			}
			last = timestamp;

			ctx.fillStyle = "rgba(5, 7, 15, 0.5)"; // 0.5 = fade effect
			ctx.fillRect(0, 0, canvas.width, canvas.height);
			
			for (let star of stars) {
				star.z -= 2; // speed of stars
				if (star.z <= 0) star.z = canvas.width;
				
				const k = 128.0 / star.z;
				const px = star.x * k + canvas.width / 2;
				const py = star.y * k + canvas.height / 2;
				
				if (px >= 0 && px <= canvas.width && py >= 0 && py <= canvas.height) {
					const size = (1 - star.z / canvas.width) * 2;
					ctx.beginPath();
					ctx.fillStyle = "rgba(255,255,255," + (1 - star.z / canvas.width) + ")";
					ctx.arc(px, py, size, 0, Math.PI * 2);
					ctx.fill();
				}
			}
			requestAnimationFrame(animate);
		}
		requestAnimationFrame(animate);
	</script> 
	
	<div class="bottom-row">
		<p style="text-align: left; margin: 0;">
			Developed by <a href="https://profiles.ucl.ac.uk/93616-connor-barker" target="_blank" rel="noopener noreferrer">Connor Barker</a> (UCL postdoc) and <a href="https://profiles.ucl.ac.uk/77783-eloise-marais" target="_blank" rel="noopener noreferrer">Eloise Marais</a> (UCL PI), in collaboration with <a href="https://www.cfa.harvard.edu/people/jonathan-mcdowell" target="_blank" rel="noopener noreferrer">Jonathan McDowell</a> (Harvard-Smithsonian Center for Astrophysics). Interested in using the data or spot any room for improvements? Please reach out to Connor Barker at <a href= "mailto:connor.barker@ucl.ac.uk">connor.barker@ucl.ac.uk. </a>
			<strong>Funding Disclaimer:</strong> This project has received funding from the European Research Council (ERC) under the European Union’s Horizon 2020 research and innovation programme (grant agreement No. 851854). <a href="https://cordis.europa.eu/project/id/851854" target="_blank" rel="noopener noreferrer">European Commission project page</a>.
		</p>
  	</div>
</body>
</html>